<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src *; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
  <title>Applicant Backend API Tester</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .back-btn {
      display: inline-block;
      padding: 4px 8px;
      font-size: 0.75rem;
      color: #666;
      text-decoration: none;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .back-btn:hover {
      background: #f5f5f5;
    }

    .header {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }

    .header h1 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header p {
      color: #666;
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border: 1px solid #ddd;
      padding: 20px;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #333;
    }

    .card p {
      color: #666;
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    button {
      padding: 10px 18px;
      border: 1px solid #ddd;
      background: #fafafa;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    button:hover {
      background: #f0f0f0;
      border-color: #999;
    }

    button:active {
      transform: scale(0.98);
      background: #e8e8e8;
    }

    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      font-family: inherit;
    }

    .response-box {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 12px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
    }

    .response-box pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .error-box {
      background: #fff5f5;
      border-color: #dc2626;
      color: #dc2626;
    }

    .loading {
      display: none;
      padding: 8px;
      color: #666;
      font-style: italic;
    }

    .loading.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 15px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .stat-card p {
      font-size: 0.8rem;
      color: #666;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Backend API Tester</h1>
      <p>Testing interface for Smart Queue System | Base URL: /api</p>
    </div>

    <div class="grid">
      <!-- Database Stats -->
      <div class="card">
        <h2>Database Statistics</h2>
        <p>View current database state and record counts</p>
        <button onclick="getStats()">Get Stats</button>
        <div id="stats-loading" class="loading">Loading...</div>
        <div id="stats-response"></div>
      </div>

      <!-- Institutes -->
      <div class="card">
        <h2>Institutes</h2>
        <p>View all registered institutes</p>
        <button onclick="getInstitutes()">Get All Institutes</button>
        <div id="institutes-loading" class="loading">Loading...</div>
        <div id="institutes-response" class="response-box"></div>
      </div>

      <!-- Services -->
      <div class="card">
        <h2>Services</h2>
        <p>View all available services</p>
        <button onclick="getServices()">Get All Services</button>
        <div id="services-loading" class="loading">Loading...</div>
        <div id="services-response" class="response-box"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Chatbot - Ping -->
      <div class="card">
        <h2>Chatbot Ping</h2>
        <p>Test if chatbot endpoint is responding</p>
        <button onclick="pingChatbot()">Ping Chatbot</button>
        <div id="ping-loading" class="loading">Loading...</div>
        <div id="ping-response" class="response-box"></div>
      </div>

      <!-- Chatbot - Start -->
      <div class="card">
        <h2>Start Conversation</h2>
        <p>Initialize a new chatbot conversation</p>
        <button onclick="startConversation()">Send "start"</button>
        <div id="start-loading" class="loading">Loading...</div>
        <div id="start-response" class="response-box"></div>
      </div>

      <!-- Chatbot - Feedback -->
      <div class="card">
        <h2>Request Feedback</h2>
        <p>Request user feedback options</p>
        <button onclick="requestFeedback()">Send "feedback"</button>
        <div id="feedback-loading" class="loading">Loading...</div>
        <div id="feedback-response" class="response-box"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Custom Closed Message -->
      <div class="card">
        <h2>Custom Closed Message</h2>
        <p>Send a custom closed-ended message</p>
        <input type="text" id="closed-message" placeholder="Enter message (e.g., 'start', 'feedback')">
        <button onclick="sendClosedMessage()">Send Message</button>
        <div id="closed-loading" class="loading">Loading...</div>
        <div id="closed-response" class="response-box"></div>
      </div>

      <!-- Open-ended Message -->
      <div class="card">
        <h2>Open-ended Message</h2>
        <p>Send a custom open-ended message</p>
        <textarea id="open-message" rows="3" placeholder="Type your message here..."></textarea>
        <button onclick="sendOpenMessage()">Send Message</button>
        <div id="open-loading" class="loading">Loading...</div>
        <div id="open-response" class="response-box"></div>
      </div>

      <!-- Sessions -->
      <div class="card">
        <h2>Active Sessions</h2>
        <p>View all active chat sessions</p>
        <button onclick="getSessions()">Get Sessions</button>
        <button onclick="clearResponse('sessions-response')">Clear</button>
        <div id="sessions-loading" class="loading">Loading...</div>
        <div id="sessions-response" class="response-box"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Queue -->
      <div class="card">
        <h2>Queue Status</h2>
        <p>View current waiting queue</p>
        <button onclick="getQueue()">Get Queue</button>
        <div id="queue-loading" class="loading">Loading...</div>
        <div id="queue-response" class="response-box"></div>
      </div>

      <!-- Tables -->
      <div class="card">
        <h2>Database Tables</h2>
        <p>List all database tables</p>
        <button onclick="getTables()">Get Tables</button>
        <div id="tables-loading" class="loading">Loading...</div>
        <div id="tables-response" class="response-box"></div>
      </div>

      <!-- QR Code -->
      <div class="card">
        <h2>QR Code Generator</h2>
        <p>Generate QR code for test page</p>
        <button onclick="getQR()">Generate QR</button>
        <div id="qr-loading" class="loading">Loading...</div>
        <div id="qr-response" class="response-box"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Session & Devices -->
      <div class="card">
        <h2>Session & Devices</h2>
        <p>Check session and device information</p>
        <button onclick="getSession()">GET /session</button>
        <button onclick="getDevices()">GET /devices</button>
        <button onclick="getServerCheck()">GET /server/check</button>
        <div id="session-loading" class="loading">Loading...</div>
        <div id="session-response" class="response-box"></div>
      </div>

      <!-- Counters List -->
      <div class="card">
        <h2>Counters</h2>
        <p>Manage counter operations</p>
        <button onclick="getCounters()">GET /counters</button>
        <button onclick="createCounter()">POST /counters (create)</button>
        <div id="counters-loading" class="loading">Loading...</div>
        <div id="counters-response" class="response-box"></div>
      </div>

      <!-- Counter by ID -->
      <div class="card">
        <h2>Counter by ID</h2>
        <p>Get, update, or delete a specific counter</p>
        <input type="text" id="counter-sessionId" placeholder="Enter session ID">
        <button onclick="getCounterById()">GET /counters/:id</button>
        <button onclick="deleteCounterById()">DELETE /counters/:id</button>
        <div id="counter-id-loading" class="loading">Loading...</div>
        <div id="counter-id-response" class="response-box"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Update Counter -->
      <div class="card">
        <h2>Update Counter</h2>
        <p>Update counter status and properties</p>
        <input type="text" id="counter-update-sessionId" placeholder="Enter session ID">
        <textarea id="counter-data" rows="4" placeholder='{"status": "active", "counterId": "counter-123"}'>{
  "status": "active"
}</textarea>
        <button onclick="updateCounter()">PUT /counters/:id</button>
        <div id="counter-update-loading" class="loading">Loading...</div>
        <div id="counter-update-response" class="response-box"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000';

    // Utility: Display response
    function displayResponse(elementId, data, isError = false) {
      console.log('displayResponse called:', elementId, data, isError);
      const element = document.getElementById(elementId);
      if (!element) {
        console.error('Element not found:', elementId);
        return;
      }
      element.className = isError ? 'response-box error-box' : 'response-box success-box';
      element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // Utility: Show/hide loading
    function setLoading(elementId, isLoading) {
      const element = document.getElementById(elementId);
      if (element) {
        element.className = isLoading ? 'loading active' : 'loading';
      }
    }

    // Utility: Clear response
    function clearResponse(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    // Database Stats
    async function getStats() {
      console.log('getStats called');
      setLoading('stats-loading', true);
      try {
        console.log('Fetching:', `${API_BASE}/api/test/stats`);
        const response = await fetch(`${API_BASE}/api/test/stats`);
        console.log('Response:', response);
        const data = await response.json();
        console.log('Data:', data);
        
        if (data.success) {
          const stats = data.data;
          const html = `
            <div class="stats-grid">
              <div class="stat-card">
                <h3>${stats.institutes.count}</h3>
                <p>Institutes</p>
              </div>
              <div class="stat-card">
                <h3>${stats.services.count}</h3>
                <p>Services</p>
              </div>
              <div class="stat-card">
                <h3>${stats.sessions.count}</h3>
                <p>Sessions</p>
              </div>
              <div class="stat-card">
                <h3>${stats.queue.count}</h3>
                <p>Queue</p>
              </div>
              <div class="stat-card">
                <h3>${stats.applicants.count}</h3>
                <p>Applicants</p>
              </div>
            </div>
          `;
          document.getElementById('stats-response').innerHTML = html;
        } else {
          const element = document.getElementById('stats-response');
          element.className = 'response-box error-box';
          element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        displayResponse('stats-response', { error: error.message }, true);
      }
      setLoading('stats-loading', false);
    }

    // Get Institutes
    async function getInstitutes() {
      setLoading('institutes-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/test/institutes`);
        const data = await response.json();
        displayResponse('institutes-response', data);
      } catch (error) {
        displayResponse('institutes-response', { error: error.message }, true);
      }
      setLoading('institutes-loading', false);
    }

    // Get Services
    async function getServices() {
      setLoading('services-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/test/services`);
        const data = await response.json();
        displayResponse('services-response', data);
      } catch (error) {
        displayResponse('services-response', { error: error.message }, true);
      }
      setLoading('services-loading', false);
    }

    // Ping Chatbot
    async function pingChatbot() {
      setLoading('ping-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/chatbot/ping`);
        const data = await response.json();
        displayResponse('ping-response', data);
      } catch (error) {
        displayResponse('ping-response', { error: error.message }, true);
      }
      setLoading('ping-loading', false);
    }

    // Start Conversation
    async function startConversation() {
      setLoading('start-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/chatbot/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Message: 'start',
            MessageType: 'closed'
          })
        });
        const data = await response.json();
        displayResponse('start-response', data);
      } catch (error) {
        displayResponse('start-response', { error: error.message }, true);
      }
      setLoading('start-loading', false);
    }

    // Request Feedback
    async function requestFeedback() {
      setLoading('feedback-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/chatbot/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Message: 'feedback',
            MessageType: 'closed'
          })
        });
        const data = await response.json();
        displayResponse('feedback-response', data);
      } catch (error) {
        displayResponse('feedback-response', { error: error.message }, true);
      }
      setLoading('feedback-loading', false);
    }

    // Send Custom Closed Message
    async function sendClosedMessage() {
      const message = document.getElementById('closed-message').value.trim();
      if (!message) {
        displayResponse('closed-response', { error: 'Please enter a message' }, true);
        return;
      }

      setLoading('closed-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/chatbot/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Message: message,
            MessageType: 'closed'
          })
        });
        const data = await response.json();
        displayResponse('closed-response', data);
      } catch (error) {
        displayResponse('closed-response', { error: error.message }, true);
      }
      setLoading('closed-loading', false);
    }

    // Send Open Message
    async function sendOpenMessage() {
      const message = document.getElementById('open-message').value.trim();
      if (!message) {
        displayResponse('open-response', { error: 'Please enter a message' }, true);
        return;
      }

      setLoading('open-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/chatbot/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Message: message,
            MessageType: 'open'
          })
        });
        const data = await response.json();
        displayResponse('open-response', data);
      } catch (error) {
        displayResponse('open-response', { error: error.message }, true);
      }
      setLoading('open-loading', false);
    }

    // Get Sessions
    async function getSessions() {
      setLoading('sessions-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/test/sessions`);
        const data = await response.json();
        displayResponse('sessions-response', data);
      } catch (error) {
        displayResponse('sessions-response', { error: error.message }, true);
      }
      setLoading('sessions-loading', false);
    }

    // Get Queue
    async function getQueue() {
      setLoading('queue-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/test/queue`);
        const data = await response.json();
        displayResponse('queue-response', data);
      } catch (error) {
        displayResponse('queue-response', { error: error.message }, true);
      }
      setLoading('queue-loading', false);
    }

    // Get Tables
    async function getTables() {
      setLoading('tables-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/test/tables`);
        const data = await response.json();
        displayResponse('tables-response', data);
      } catch (error) {
        displayResponse('tables-response', { error: error.message }, true);
      }
      setLoading('tables-loading', false);
    }

    // Get QR Code
    async function getQR() {
      setLoading('qr-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/qr`);
        const data = await response.json();
        
        if (data.qr) {
          document.getElementById('qr-response').innerHTML = `
            <img src="${data.qr}" alt="QR Code" style="max-width: 200px; display: block; margin: 10px auto;">
          `;
        } else {
          displayResponse('qr-response', data);
        }
      } catch (error) {
        displayResponse('qr-response', { error: error.message }, true);
      }
      setLoading('qr-loading', false);
    }

    // Auto-load stats on page load
    window.addEventListener('DOMContentLoaded', () => {
      getStats();
    });

    // Session & Devices
    async function getSession() {
      setLoading('session-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/session`, {
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('session-response', data);
      } catch (error) {
        displayResponse('session-response', { error: error.message }, true);
      }
      setLoading('session-loading', false);
    }

    async function getDevices() {
      setLoading('session-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/devices`, {
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('session-response', data);
      } catch (error) {
        displayResponse('session-response', { error: error.message }, true);
      }
      setLoading('session-loading', false);
    }

    async function getServerCheck() {
      setLoading('session-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/server/check`, {
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('session-response', data);
      } catch (error) {
        displayResponse('session-response', { error: error.message }, true);
      }
      setLoading('session-loading', false);
    }

    // Counters
    async function getCounters() {
      setLoading('counters-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/counters`, {
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('counters-response', data);
      } catch (error) {
        displayResponse('counters-response', { error: error.message }, true);
      }
      setLoading('counters-loading', false);
    }

    async function createCounter() {
      setLoading('counters-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/counters`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        displayResponse('counters-response', data);
      } catch (error) {
        displayResponse('counters-response', { error: error.message }, true);
      }
      setLoading('counters-loading', false);
    }

    // Counter by ID
    async function getCounterById() {
      const sessionId = document.getElementById('counter-sessionId').value.trim();
      if (!sessionId) {
        displayResponse('counter-id-response', { error: 'Session ID is required' }, true);
        return;
      }

      setLoading('counter-id-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/counters/${sessionId}`, {
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('counter-id-response', data);
      } catch (error) {
        displayResponse('counter-id-response', { error: error.message }, true);
      }
      setLoading('counter-id-loading', false);
    }

    async function deleteCounterById() {
      const sessionId = document.getElementById('counter-sessionId').value.trim();
      if (!sessionId) {
        displayResponse('counter-id-response', { error: 'Session ID is required' }, true);
        return;
      }

      if (!confirm(`Are you sure you want to delete counter with session ID: ${sessionId}?`)) {
        return;
      }

      setLoading('counter-id-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/counters/${sessionId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await response.json();
        displayResponse('counter-id-response', data);
      } catch (error) {
        displayResponse('counter-id-response', { error: error.message }, true);
      }
      setLoading('counter-id-loading', false);
    }

    // Update Counter
    async function updateCounter() {
      const sessionId = document.getElementById('counter-update-sessionId').value.trim();
      const counterDataRaw = document.getElementById('counter-data').value.trim();

      if (!sessionId) {
        displayResponse('counter-update-response', { error: 'Session ID is required' }, true);
        return;
      }

      let counterData;
      try {
        counterData = JSON.parse(counterDataRaw);
      } catch (e) {
        displayResponse('counter-update-response', { error: 'Invalid JSON in Counter Data field: ' + e.message }, true);
        return;
      }

      setLoading('counter-update-loading', true);
      try {
        const response = await fetch(`${API_BASE}/api/counters/${sessionId}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ counter: counterData })
        });
        const data = await response.json();
        displayResponse('counter-update-response', data);
      } catch (error) {
        displayResponse('counter-update-response', { error: error.message }, true);
      }
      setLoading('counter-update-loading', false);
    }
  </script>
</body>
</html>
