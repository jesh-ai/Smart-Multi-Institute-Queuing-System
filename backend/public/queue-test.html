<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Queue Management System - Test Interface</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: white;
    }
    .test-section h2 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    .action-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .action-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #3498db;
      color: white;
    }
    .btn-primary:hover {
      background: #2980b9;
    }
    .btn-success {
      background: #2ecc71;
      color: white;
    }
    .btn-success:hover {
      background: #27ae60;
    }
    .btn-warning {
      background: #f39c12;
      color: white;
    }
    .btn-warning:hover {
      background: #e67e22;
    }
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .input-group {
      margin: 15px 0;
    }
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #34495e;
    }
    .input-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
    }
    .response-container {
      margin: 15px 0;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 5px;
      border-left: 4px solid #3498db;
    }
    .response-container.success {
      border-left-color: #2ecc71;
      background: #d5f4e6;
    }
    .response-container.error {
      border-left-color: #e74c3c;
      background: #fadbd8;
    }
    .response-container pre {
      margin: 0;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .stat-card {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.9;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
    }
    .queue-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    .queue-table th,
    .queue-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .queue-table th {
      background: #34495e;
      color: white;
      font-weight: bold;
    }
    .queue-table tr:hover {
      background: #f5f5f5;
    }
    .priority-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
    }
    .priority-yes {
      background: #e74c3c;
      color: white;
    }
    .priority-no {
      background: #95a5a6;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üé´ Queue Management System - Test Interface</h1>
      <p>Comprehensive testing interface for the Smart Queue System</p>
    </div>

    <!-- Session Setup Section -->
    <div class="test-section">
      <h2>üìã Session Setup (Simulate Users)</h2>
      <p>Create test sessions to simulate counters and applicants</p>
      
      <div class="action-group">
        <button class="btn-success" onclick="openCounter()">üñ•Ô∏è Open Counter Session</button>
        <button class="btn-warning" onclick="closeCounter()">üîí Close Counter Session</button>
        <button class="btn-success" onclick="submitApplicant(false)">üë§ Submit Applicant (Regular)</button>
        <button class="btn-warning" onclick="submitApplicant(true)">‚≠ê Submit Applicant (Priority)</button>
        <button class="btn-danger" onclick="serveApplicant()">‚úÖ Mark Applicant Served</button>
      </div>
      
      <div id="session-response" class="response-container" style="display: none;"></div>
    </div>

    <!-- Queue Status Section -->
    <div class="test-section">
      <h2>üìä Queue Status Overview</h2>
      <p>View complete queue distribution and statistics</p>
      
      <div class="action-group">
        <button class="btn-primary" onclick="getQueueStatus()">üîÑ Refresh Queue Status</button>
        <button class="btn-primary" onclick="autoRefresh()">‚è±Ô∏è Auto-Refresh (5s)</button>
      </div>
      
      <div id="stats-container"></div>
      <div id="queue-status-response" class="response-container" style="display: none;"></div>
    </div>

    <!-- Applicant Position Section -->
    <div class="test-section">
      <h2>üîç Check Applicant Position</h2>
      <p>Check queue position for specific applicant session</p>
      
      <div class="input-group">
        <label for="applicant-session-id">Session ID (leave empty for current session):</label>
        <input type="text" id="applicant-session-id" placeholder="e.g., abc123xyz">
      </div>
      
      <div class="action-group">
        <button class="btn-primary" onclick="getApplicantPosition()">üéØ Check Position</button>
      </div>
      
      <div id="applicant-position-response" class="response-container" style="display: none;"></div>
    </div>

    <!-- Counter Queue Section -->
    <div class="test-section">
      <h2>üñ•Ô∏è Counter Queue View</h2>
      <p>View queue for specific counter</p>
      
      <div class="input-group">
        <label for="counter-session-id">Counter Session ID (leave empty for current session):</label>
        <input type="text" id="counter-session-id" placeholder="e.g., counter-xyz123">
      </div>
      
      <div class="action-group">
        <button class="btn-primary" onclick="getCounterQueue()">üìã Get Counter Queue</button>
        <button class="btn-success" onclick="getNextApplicant()">‚û°Ô∏è Get Next Applicant</button>
      </div>
      
      <div id="counter-queue-response" class="response-container" style="display: none;"></div>
    </div>

    <!-- Current Session Info -->
    <div class="test-section">
      <h2>üîê Current Session Info</h2>
      <p>View information about your current session</p>
      
      <div class="action-group">
        <button class="btn-primary" onclick="getCurrentSession()">üìÑ View Current Session</button>
      </div>
      
      <div id="current-session-response" class="response-container" style="display: none;"></div>
    </div>
  </div>

  <script>
    let autoRefreshInterval = null;

    // Helper function to display responses
    function displayResponse(containerId, data, isError = false) {
      const container = document.getElementById(containerId);
      container.style.display = 'block';
      container.className = isError ? 'response-container error' : 'response-container success';
      container.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    }

    // Helper function for API calls
    async function apiCall(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(endpoint, options);
      return response.json();
    }

    // Session Setup Functions
    async function openCounter() {
      try {
        // This would typically be handled by your counter application
        // For testing, we'll show the API call
        displayResponse('session-response', {
          message: 'To open a counter, your session needs to set:',
          sessionData: {
            counter: {
              dateOpened: new Date().toISOString()
            }
          },
          note: 'This is typically done through the counter application login'
        });
      } catch (error) {
        displayResponse('session-response', { error: error.message }, true);
      }
    }

    async function closeCounter() {
      displayResponse('session-response', {
        message: 'To close a counter, update session with:',
        sessionData: {
          counter: {
            dateClosed: new Date().toISOString()
          }
        }
      });
    }

    async function submitApplicant(isPriority) {
      displayResponse('session-response', {
        message: 'To submit an applicant, session needs:',
        sessionData: {
          applicant: {
            name: 'Test User',
            document: 'BIR Form 1901',
            isPriority: isPriority,
            dateSubmitted: new Date().toISOString()
          }
        },
        priority: isPriority ? 'PRIORITY' : 'Regular'
      });
    }

    async function serveApplicant() {
      displayResponse('session-response', {
        message: 'To mark applicant as served, update session with:',
        sessionData: {
          applicant: {
            dateServed: new Date().toISOString()
          }
        }
      });
    }

    // Queue Status Functions
    async function getQueueStatus() {
      try {
        const data = await apiCall('/api/queue/status');
        
        // Display statistics
        if (data.success && data.data.statistics) {
          const stats = data.data.statistics;
          const statsHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <h3>Active Counters</h3>
                <div class="value">${stats.totalActiveCounters}</div>
              </div>
              <div class="stat-card">
                <h3>Waiting Applicants</h3>
                <div class="value">${stats.totalWaitingApplicants}</div>
              </div>
              <div class="stat-card">
                <h3>Priority</h3>
                <div class="value">${stats.priorityApplicants}</div>
              </div>
              <div class="stat-card">
                <h3>Regular</h3>
                <div class="value">${stats.regularApplicants}</div>
              </div>
            </div>
          `;
          document.getElementById('stats-container').innerHTML = statsHTML;
          
          // Display queue distribution table
          if (data.data.queueDistribution && data.data.queueDistribution.length > 0) {
            let tableHTML = '<h3>Queue Distribution</h3>';
            data.data.queueDistribution.forEach(counter => {
              tableHTML += `
                <h4>${counter.counterName || counter.counterId} (${counter.applicants.length} applicants)</h4>
                <table class="queue-table">
                  <thead>
                    <tr>
                      <th>Position</th>
                      <th>Name</th>
                      <th>Document</th>
                      <th>Priority</th>
                      <th>Submitted</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              counter.applicants.forEach(applicant => {
                tableHTML += `
                  <tr>
                    <td><strong>#${applicant.position}</strong></td>
                    <td>${applicant.name || 'N/A'}</td>
                    <td>${applicant.document || 'N/A'}</td>
                    <td><span class="priority-badge priority-${applicant.isPriority ? 'yes' : 'no'}">${applicant.isPriority ? 'YES' : 'NO'}</span></td>
                    <td>${new Date(applicant.dateSubmitted).toLocaleString()}</td>
                  </tr>
                `;
              });
              
              tableHTML += '</tbody></table>';
            });
            document.getElementById('stats-container').innerHTML += tableHTML;
          }
        }
        
        displayResponse('queue-status-response', data, !data.success);
      } catch (error) {
        displayResponse('queue-status-response', { error: error.message }, true);
      }
    }

    function autoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        alert('Auto-refresh stopped');
      } else {
        getQueueStatus();
        autoRefreshInterval = setInterval(getQueueStatus, 5000);
        alert('Auto-refresh started (every 5 seconds)');
      }
    }

    // Applicant Position Functions
    async function getApplicantPosition() {
      try {
        const sessionId = document.getElementById('applicant-session-id').value.trim();
        const endpoint = sessionId 
          ? `/api/queue/applicant/${sessionId}`
          : '/api/queue/applicant';
        
        const data = await apiCall(endpoint);
        displayResponse('applicant-position-response', data, !data.success);
      } catch (error) {
        displayResponse('applicant-position-response', { error: error.message }, true);
      }
    }

    // Counter Queue Functions
    async function getCounterQueue() {
      try {
        const counterId = document.getElementById('counter-session-id').value.trim();
        const endpoint = counterId 
          ? `/api/queue/counter/${counterId}`
          : '/api/queue/counter';
        
        const data = await apiCall(endpoint);
        displayResponse('counter-queue-response', data, !data.success);
      } catch (error) {
        displayResponse('counter-queue-response', { error: error.message }, true);
      }
    }

    async function getNextApplicant() {
      try {
        const data = await apiCall('/api/queue/counter/next');
        displayResponse('counter-queue-response', data, !data.success);
      } catch (error) {
        displayResponse('counter-queue-response', { error: error.message }, true);
      }
    }

    // Current Session Functions
    async function getCurrentSession() {
      try {
        const data = await apiCall('/api/session/self');
        displayResponse('current-session-response', data);
      } catch (error) {
        displayResponse('current-session-response', { error: error.message }, true);
      }
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
